<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python相关🔥 | Jack Zheng的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="资深码农，专注平台工具开发">
    
    <link rel="preload" href="/blogs/assets/css/0.styles.1189137d.css" as="style"><link rel="preload" href="/blogs/assets/js/app.f400a914.js" as="script"><link rel="preload" href="/blogs/assets/js/7.ebdb849f.js" as="script"><link rel="preload" href="/blogs/assets/js/2.cd33bdb9.js" as="script"><link rel="preload" href="/blogs/assets/js/1.5c5de54b.js" as="script"><link rel="preload" href="/blogs/assets/js/47.dc54d0bf.js" as="script"><link rel="prefetch" href="/blogs/assets/js/10.d3726253.js"><link rel="prefetch" href="/blogs/assets/js/11.83dcbbc8.js"><link rel="prefetch" href="/blogs/assets/js/14.159372c7.js"><link rel="prefetch" href="/blogs/assets/js/15.53daba4f.js"><link rel="prefetch" href="/blogs/assets/js/16.a7ead973.js"><link rel="prefetch" href="/blogs/assets/js/17.11536d6a.js"><link rel="prefetch" href="/blogs/assets/js/18.bf4ddf76.js"><link rel="prefetch" href="/blogs/assets/js/19.dd24f890.js"><link rel="prefetch" href="/blogs/assets/js/20.fd8156bf.js"><link rel="prefetch" href="/blogs/assets/js/21.c06c66f0.js"><link rel="prefetch" href="/blogs/assets/js/22.741cb199.js"><link rel="prefetch" href="/blogs/assets/js/23.c33379bd.js"><link rel="prefetch" href="/blogs/assets/js/24.cb7781fd.js"><link rel="prefetch" href="/blogs/assets/js/25.95e84b36.js"><link rel="prefetch" href="/blogs/assets/js/26.097df3f1.js"><link rel="prefetch" href="/blogs/assets/js/27.9d6d8556.js"><link rel="prefetch" href="/blogs/assets/js/28.541c89d1.js"><link rel="prefetch" href="/blogs/assets/js/29.60b8eefd.js"><link rel="prefetch" href="/blogs/assets/js/3.bd1e7f78.js"><link rel="prefetch" href="/blogs/assets/js/30.9dcbf795.js"><link rel="prefetch" href="/blogs/assets/js/31.5cb42074.js"><link rel="prefetch" href="/blogs/assets/js/32.50594513.js"><link rel="prefetch" href="/blogs/assets/js/33.57c36707.js"><link rel="prefetch" href="/blogs/assets/js/34.cb4a6541.js"><link rel="prefetch" href="/blogs/assets/js/35.858c4178.js"><link rel="prefetch" href="/blogs/assets/js/36.c7ecfe19.js"><link rel="prefetch" href="/blogs/assets/js/37.7dc7c5dc.js"><link rel="prefetch" href="/blogs/assets/js/38.9b828b5d.js"><link rel="prefetch" href="/blogs/assets/js/39.8e971a26.js"><link rel="prefetch" href="/blogs/assets/js/4.cf8160ec.js"><link rel="prefetch" href="/blogs/assets/js/40.b326b128.js"><link rel="prefetch" href="/blogs/assets/js/41.7cdd1315.js"><link rel="prefetch" href="/blogs/assets/js/42.cd0d38d7.js"><link rel="prefetch" href="/blogs/assets/js/43.09e35e0f.js"><link rel="prefetch" href="/blogs/assets/js/44.651f8bf3.js"><link rel="prefetch" href="/blogs/assets/js/45.d242c600.js"><link rel="prefetch" href="/blogs/assets/js/46.7cf14edc.js"><link rel="prefetch" href="/blogs/assets/js/48.830be867.js"><link rel="prefetch" href="/blogs/assets/js/49.427385db.js"><link rel="prefetch" href="/blogs/assets/js/5.7ee670a4.js"><link rel="prefetch" href="/blogs/assets/js/50.9ae935d0.js"><link rel="prefetch" href="/blogs/assets/js/6.4361c4be.js"><link rel="prefetch" href="/blogs/assets/js/8.0d05066c.js"><link rel="prefetch" href="/blogs/assets/js/9.9ac6e2ac.js"><link rel="prefetch" href="/blogs/assets/js/vendors~docsearch.1db7383c.js">
    <link rel="stylesheet" href="/blogs/assets/css/0.styles.1189137d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Jack Zheng的博客</h3> <p class="description" data-v-59e6cb88>资深码农，专注平台工具开发</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Jack Zheng</span>
          
        <!---->
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blogs/" class="home-link router-link-active"><img src="/blogs/avatar.png" alt="Jack Zheng的博客" class="logo"> <span class="site-name">Jack Zheng的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blogs/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      笔记
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/数据库/" class="nav-link"><i class="undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/操作系统/" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/人工智能/" class="nav-link"><i class="undefined"></i>
  人工智能
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/容器化/" class="nav-link"><i class="undefined"></i>
  容器化
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/编程/" class="nav-link"><i class="undefined"></i>
  编程
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      我的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://zhengxiaojun.github.io/home/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/blogs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/blogs/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    Jack Zheng
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>27</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/blogs/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      笔记
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/数据库/" class="nav-link"><i class="undefined"></i>
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/操作系统/" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/人工智能/" class="nav-link"><i class="undefined"></i>
  人工智能
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/容器化/" class="nav-link"><i class="undefined"></i>
  容器化
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/运维/" class="nav-link"><i class="undefined"></i>
  运维
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/blogs/categories/编程/" class="nav-link"><i class="undefined"></i>
  编程
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      我的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://zhengxiaojun.github.io/home/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/blogs/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Python相关🔥</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>Jack Zheng</span>
          
        <!---->
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">Python相关🔥</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>Jack Zheng</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/9/26</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>python</span><span class="tag-item" data-v-8a445198>后端</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title"></p><p>pip 安装依赖包</p></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 清华源：https://pypi.tuna.tsinghua.edu.cn/simple</span>

<span class="token comment"># 豆瓣源：http://pypi.douban.com/simple</span>

<span class="token comment"># 阿里源：http://mirrors.aliyun.com/pypi/simple/</span>

例如：
pip <span class="token function">install</span> 依赖包 <span class="token parameter variable">--proxy</span><span class="token operator">=</span>http://xx.xx.xx.xx:8888 <span class="token parameter variable">-i</span> http://mirrors.aliyun.com/pypi/simple/ --trusted-host<span class="token operator">=</span>mirrors.aliyun.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>from Crypto.Cipher import AES 安装 Crypto</p></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>pip <span class="token function">install</span> <span class="token assign-left variable">pycryptodome</span><span class="token operator">==</span><span class="token number">3.10</span>.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>Python在线运行IDE: Jupyterlab</p></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>pip <span class="token function">install</span> jupyterlab <span class="token parameter variable">-i</span>  https://pypi.tuna.tsinghua.edu.cn/simple
jupyter lab --generate-config
<span class="token function">vim</span> ~/.jupyter/jupyter_lab_config.py
`<span class="token variable"><span class="token variable">`</span>
c.ServerApp.ip <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span>  <span class="token comment"># 替换为你的IP地址或使用'*'监听所有</span>
c.ServerApp.port <span class="token operator">=</span> <span class="token number">9988</span>  <span class="token comment"># 替换为你希望的端口号</span>
<span class="token variable">`</span></span>`
jupyter lab password
执行：jupyter lab
后台执行：nohup jupyter lab <span class="token operator">&gt;</span> jupyter.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>Python搭建FTP服务</p></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- encoding: utf-8 -*-</span>

<span class="token keyword">import</span> http<span class="token punctuation">.</span>server
<span class="token keyword">import</span> socketserver
<span class="token keyword">import</span> base64

USERNAME <span class="token operator">=</span> <span class="token string">'ftp_test'</span>
PASSWORD <span class="token operator">=</span> <span class="token string">'ftp_test123!!'</span>

AUTH_KEY <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token string">'{}:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>USERNAME<span class="token punctuation">,</span> PASSWORD<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">BasicAuthHandler</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>SimpleHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">do_HEAD</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">&quot;Content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_auth_head</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">&quot;WWW-Authenticate&quot;</span><span class="token punctuation">,</span> <span class="token string">'Basic realm=&quot;FileServer&quot;'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">&quot;Content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot; Present frontpage with user authentication. &quot;&quot;&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>do_auth_head<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&quot;no auth header received&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;Basic &quot;</span> <span class="token operator">+</span> AUTH_KEY<span class="token punctuation">:</span>
            <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>do_GET<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>do_auth_head<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;Authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b&quot;not authenticated&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ThreadingHTTPServer</span><span class="token punctuation">(</span>socketserver<span class="token punctuation">.</span>ThreadingMixIn<span class="token punctuation">,</span> http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    daemon_threads <span class="token operator">=</span> <span class="token boolean">True</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> <span class="token number">9988</span>
    address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'server listening at'</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span>
    <span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span>address<span class="token punctuation">,</span> BasicAuthHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
        httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>Python搭建Mock服务</p></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># -*- encoding: utf-8 -*-</span>
<span class="token keyword">from</span> abc <span class="token keyword">import</span> ABC
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>options <span class="token keyword">import</span> options

<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>httpserver
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>ioloop
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>web
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>log
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> pymysql
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> json5
<span class="token keyword">import</span> os
<span class="token keyword">import</span> re
<span class="token keyword">import</span> redis

redis_conn <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'xx.xx.xx.xx'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MyDB</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> user<span class="token punctuation">,</span> pwd<span class="token punctuation">,</span> dbname<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span> port<span class="token operator">=</span>port<span class="token punctuation">,</span> user<span class="token operator">=</span>user<span class="token punctuation">,</span> passwd<span class="token operator">=</span>pwd<span class="token punctuation">,</span> db<span class="token operator">=</span>dbname<span class="token punctuation">,</span> charset<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>autocommit<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cur <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span>cursor<span class="token operator">=</span>pymysql<span class="token punctuation">.</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>
        results <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            results <span class="token operator">=</span> self<span class="token punctuation">.</span>cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

        msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;\n\n【SQL】 </span><span class="token interpolation"><span class="token punctuation">{</span>sql<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        msg <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;【Results】\n </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

        <span class="token keyword">return</span> results

    <span class="token keyword">def</span> <span class="token function">exec</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">LogFormatter</span><span class="token punctuation">(</span>tornado<span class="token punctuation">.</span>log<span class="token punctuation">.</span>LogFormatter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>LogFormatter<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            fmt<span class="token operator">=</span><span class="token string">'%(color)s[%(asctime)s %(filename)s:%(funcName)s:%(lineno)d %(levelname)s]%(end_color)s %(message)s'</span><span class="token punctuation">,</span>
            datefmt<span class="token operator">=</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span>
        <span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MockRuleHandler</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> MyDB<span class="token punctuation">(</span>options<span class="token punctuation">.</span>mysql_host<span class="token punctuation">,</span> options<span class="token punctuation">.</span>mysql_port<span class="token punctuation">,</span> options<span class="token punctuation">.</span>mysql_user<span class="token punctuation">,</span> options<span class="token punctuation">.</span>mysql_pwd<span class="token punctuation">,</span> options<span class="token punctuation">.</span>mysql_db<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>api_id <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>http_code <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>delay_time <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">check_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_info<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>response <span class="token operator">=</span> resp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>response <span class="token operator">=</span> api_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">check_decision</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_info<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> _path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        body <span class="token operator">=</span> json5<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token keyword">if</span> body <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> body <span class="token operator">!=</span> <span class="token string">b''</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        mobile <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'mobile'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'mobile'</span> <span class="token keyword">in</span> params <span class="token keyword">else</span> <span class="token string">''</span>
        mobile <span class="token operator">=</span> body<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'mobile'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'mobile'</span> <span class="token keyword">in</span> body <span class="token keyword">else</span> mobile
        identity_no <span class="token operator">=</span> params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity_no'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'identity_no'</span> <span class="token keyword">in</span> params <span class="token keyword">else</span> <span class="token string">''</span>
        identity_no <span class="token operator">=</span> body<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'identity_no'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'identity_no'</span> <span class="token keyword">in</span> body <span class="token keyword">else</span> identity_no

        sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;select d_type from mock_decision where mobile='</span><span class="token interpolation"><span class="token punctuation">{</span>mobile<span class="token punctuation">}</span></span><span class="token string">' or identity_no='</span><span class="token interpolation"><span class="token punctuation">{</span>identity_no<span class="token punctuation">}</span></span><span class="token string">' order by create_time desc;&quot;</span></span>
        resp <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            rule_dict <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;1&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;A决策&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;2&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;B决策&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;3&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;A-次级捞回&quot;</span>
            <span class="token punctuation">}</span>
            rule_name <span class="token operator">=</span> rule_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>resp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'d_type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">'A决策'</span>
            <span class="token comment"># sql = f&quot;select response from mock_api_rules where name='{rule_name}' and enabled=true order by update_time desc limit 1;&quot;</span>
            sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;
                select * from mock_api_rules as mar 
                left join mock_api_info as mai on mar.api_id = mai.id
                where mar.name='</span><span class="token interpolation"><span class="token punctuation">{</span>rule_name<span class="token punctuation">}</span></span><span class="token string">' and mar.enabled=true and mai.`path` ='</span><span class="token interpolation"><span class="token punctuation">{</span>_path<span class="token punctuation">}</span></span><span class="token string">'
                order by mar.update_time desc
                limit 1;
            &quot;&quot;&quot;</span></span>
            resp <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>check_response<span class="token punctuation">(</span>api_info<span class="token punctuation">,</span> resp<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">check_rules</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;select response from mock_api_rules where api_id='</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>api_id<span class="token punctuation">}</span></span><span class="token string">' and enabled=true order by update_time desc limit 1;&quot;</span></span>
        resp <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>check_response<span class="token punctuation">(</span>api_info<span class="token punctuation">,</span> resp<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">decision_a</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_info<span class="token punctuation">,</span> _path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># sql = f&quot;select response from mock_api_rules where api_id='{self.api_id}' and name='A决策' order by update_time desc limit 1;&quot;</span>
        sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;&quot;&quot;
                select * from mock_api_rules as mar 
                left join mock_api_info as mai on mar.api_id = mai.id
                where mar.name='A决策' and mar.enabled=true and mai.`path` ='</span><span class="token interpolation"><span class="token punctuation">{</span>_path<span class="token punctuation">}</span></span><span class="token string">'
                order by mar.update_time desc
                limit 1;
        &quot;&quot;&quot;</span></span>
        resp <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>check_response<span class="token punctuation">(</span>api_info<span class="token punctuation">,</span> resp<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">match_rule</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>api_id <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r&quot;\d+\.?\d*&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        _path <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>self<span class="token punctuation">.</span>api_id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        _key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>api_id<span class="token punctuation">}</span></span><span class="token string">_result'</span></span>
        <span class="token comment"># 判断缓存</span>
        value <span class="token operator">=</span> redis_conn<span class="token punctuation">.</span>get<span class="token punctuation">(</span>_key<span class="token punctuation">)</span>
        <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># 如果缓存中没有值，进行计算或数据库查询</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'开始查询Mock接口是否存在'</span><span class="token punctuation">)</span>
            sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;select response,delay_time,http_code,`check` from mock_api_info where id='</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>api_id<span class="token punctuation">}</span></span><span class="token string">' and path='</span><span class="token interpolation"><span class="token punctuation">{</span>_path<span class="token punctuation">}</span></span><span class="token string">';&quot;</span></span>
            api_info <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>api_info<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;无此接口，请检查接口信息是否正确&quot;</span><span class="token punctuation">}</span>
                self<span class="token punctuation">.</span>http_code <span class="token operator">=</span> <span class="token number">404</span>
                self<span class="token punctuation">.</span>delay_time <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                api_info <span class="token operator">=</span> api_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>http_code <span class="token operator">=</span> api_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http_code'</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>delay_time <span class="token operator">=</span> api_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'delay_time'</span><span class="token punctuation">)</span>
                check <span class="token operator">=</span> api_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'check'</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> check<span class="token punctuation">:</span>  <span class="token comment"># 校验入参</span>
                    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'开始校验决策入参逻辑，匹配决策数据，匹配到取决策返回值'</span><span class="token punctuation">)</span>
                    <span class="token comment"># 按是否匹配决策数据，匹配到取决策返回值</span>
                    self<span class="token punctuation">.</span>check_decision<span class="token punctuation">(</span>api_info<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> _path<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>response <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token boolean">None</span>

                    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'开始校验决策入参逻辑，未匹配到决策数据，默认走A決策'</span><span class="token punctuation">)</span>
                    <span class="token comment"># 未匹配到决策数据，默认走A决策</span>
                    self<span class="token punctuation">.</span>decision_a<span class="token punctuation">(</span>api_info<span class="token punctuation">,</span> _path<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>response <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> self<span class="token punctuation">.</span>response

                    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'开始校验规则逻辑'</span><span class="token punctuation">)</span>
                    <span class="token comment"># 校验规则，启用按最新时间的值返回</span>
                    self<span class="token punctuation">.</span>check_rules<span class="token punctuation">(</span>api_info<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>response <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> self<span class="token punctuation">.</span>response

                    <span class="token comment"># 默认返回值</span>
                    self<span class="token punctuation">.</span>response <span class="token operator">=</span> api_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>response <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> self<span class="token punctuation">.</span>response
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>response <span class="token operator">=</span> api_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>response <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json5<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>self<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 去除注释</span>

            <span class="token comment"># 非缓存接口清单</span>
            no_cache_api_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'110'</span><span class="token punctuation">,</span> <span class="token string">'216'</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>api_id <span class="token keyword">not</span> <span class="token keyword">in</span> no_cache_api_list<span class="token punctuation">:</span>
                <span class="token comment"># 将结果存储在缓存中，以便下次使用</span>
                result <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token string">&quot;http_code&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>http_code<span class="token punctuation">,</span>
                    <span class="token string">&quot;delay_time&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>delay_time<span class="token punctuation">,</span>
                    <span class="token string">&quot;response&quot;</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>response
                <span class="token punctuation">}</span>
                redis_conn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>_key<span class="token punctuation">,</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'缓存中存在</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>api_id<span class="token punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">接口信息，直接返回'</span></span><span class="token punctuation">)</span>
            value <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>http_code <span class="token operator">=</span> value<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'http_code'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>delay_time <span class="token operator">=</span> value<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'delay_time'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>response <span class="token operator">=</span> value<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">MockApiHandler</span><span class="token punctuation">(</span>tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">,</span> ABC<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mock_rule <span class="token operator">=</span> MockRuleHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        mock_rule<span class="token punctuation">.</span>match_rule<span class="token punctuation">(</span>path<span class="token punctuation">,</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query_arguments<span class="token punctuation">,</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        resp <span class="token operator">=</span> mock_rule<span class="token punctuation">.</span>response
        delay_time <span class="token operator">=</span> mock_rule<span class="token punctuation">.</span>delay_time
        http_code <span class="token operator">=</span> mock_rule<span class="token punctuation">.</span>http_code

        <span class="token keyword">if</span> delay_time <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay_time<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>format_log<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>set_status<span class="token punctuation">(</span>http_code<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>set_header<span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json;charset=UTF-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            resp <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        <span class="token keyword">except</span> ValueError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span>e<span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">&quot;err&quot;</span><span class="token punctuation">:</span> e<span class="token punctuation">.</span>__str__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">format_log</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'请求完整信息'</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;\n\n【Headers】:\n</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>headers<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
        msg <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;【Method】:\n        </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        msg <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;【Path】:\n        </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>uri<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        msg <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;【Params】:\n        </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query_arguments<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        msg <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;【Body】:\n        </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        msg <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f&quot;【Response】:\n        </span><span class="token interpolation"><span class="token punctuation">{</span>resp<span class="token punctuation">}</span></span><span class="token string">\n&quot;</span></span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">patch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;run on the given address&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">8891</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;run on the given port&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;mysql_host&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;xx.xx.xx.xx&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;mysql host&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;mysql_port&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;mysql port&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;mysql_user&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;mysql user&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;mysql_pwd&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;xxxxxx&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;mysql password&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>define<span class="token punctuation">(</span><span class="token string">&quot;mysql_db&quot;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">&quot;mysql dbname&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>

    options<span class="token punctuation">.</span>log_file_prefix <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'server.log'</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>parse_command_line<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 定义app</span>
    app <span class="token operator">=</span> tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>
        handlers<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token punctuation">(</span><span class="token string">r&quot;/(.*)&quot;</span><span class="token punctuation">,</span> MockApiHandler<span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">[</span>log<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>LogFormatter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> log <span class="token keyword">in</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>handlers<span class="token punctuation">]</span>
    http_server <span class="token operator">=</span> tornado<span class="token punctuation">.</span>httpserver<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span>options<span class="token punctuation">.</span>port<span class="token punctuation">,</span> options<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 默认开启跟cpu相同内核数的进程</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'server started'</span><span class="token punctuation">)</span>
    tornado<span class="token punctuation">.</span>ioloop<span class="token punctuation">.</span>IOLoop<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>LangChain SQL Agent后端服务 - 数据猎手</p></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> colorama <span class="token keyword">import</span> Fore
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> HTTPException
<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>utilities <span class="token keyword">import</span> SQLDatabase
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>agent_toolkits <span class="token keyword">import</span> create_sql_agent
<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI
<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI

<span class="token keyword">import</span> uvicorn
<span class="token keyword">import</span> json
<span class="token keyword">import</span> os

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;HTTP_PROXY&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;xx.xx.xx.xx:xxxx&quot;</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;HTTPS_PROXY&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;xx.xx.xx.xx:xxxx&quot;</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">&quot;OPENAI_API_KEY&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;xxxxxxxxxxxxxxx&quot;</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 从MySQL URI创建SQLDatabase实例</span>
<span class="token comment"># 替换下面的用户名、密码、主机、端口和数据库名称为你的实际配置</span>
db <span class="token operator">=</span> SQLDatabase<span class="token punctuation">.</span>from_uri<span class="token punctuation">(</span><span class="token string">&quot;mysql+pymysql://user:password@xx.xx.xx.xx:xxxx/database&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dialect<span class="token punctuation">)</span>  <span class="token comment"># 打印数据库方言，用于识别和适应不同的SQL方言</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>get_usable_table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印可用的表名列表</span>
<span class="token comment"># db.run(&quot;SELECT * FROM Artist LIMIT 10;&quot;)  # 执行SQL查询，并打印结果</span>

llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model_name<span class="token operator">=</span><span class="token string">&quot;gpt-4o-2024-05-13&quot;</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># llm = ChatOpenAI(</span>
<span class="token comment">#     model_name='model_name',</span>
<span class="token comment">#     openai_api_base='http://xx.xx.xx.xx:xxxx/v1',</span>
<span class="token comment">#     openai_api_key='EMPTY',</span>
<span class="token comment">#     streaming=True,</span>
<span class="token comment"># )</span>

<span class="token comment"># response = llm.stream(</span>
<span class="token comment">#             input=&quot;你好&quot;,  # Chat history</span>
<span class="token comment">#             # temperature=0,  # Temperature for text generation</span>
<span class="token comment">#         )</span>
<span class="token comment"># for chunk in response:</span>
<span class="token comment">#     content = chunk.content or &quot;&quot;</span>
<span class="token comment">#     print(Fore.GREEN + content, end=&quot;&quot;, flush=True)</span>

agent_executor <span class="token operator">=</span> create_sql_agent<span class="token punctuation">(</span>llm<span class="token punctuation">,</span> db<span class="token operator">=</span>db<span class="token punctuation">,</span> agent_type<span class="token operator">=</span><span class="token string">&quot;openai-tools&quot;</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">QueryRequest</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question<span class="token punctuation">:</span> <span class="token builtin">str</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">&quot;/query&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">query</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> QueryRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> request<span class="token punctuation">.</span>question

    <span class="token keyword">if</span> <span class="token keyword">not</span> question<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">&quot;No question provided&quot;</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用agent_executor执行查询</span>
        message <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token string">&quot;你是智能SQL查询助理，专门负责根据用户的问题，高效查询数据库信息，&quot;</span>
            <span class="token string-interpolation"><span class="token string">f&quot;用户问题：</span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token string">&quot;返回结果必须按如下json格式，不包含其他信息&quot;</span>
            <span class="token string">&quot;{\&quot;query_sql\&quot;: \&quot;query_sql\&quot;,\&quot;result_type\&quot;: \&quot;text or code\&quot;,\&quot;result_data\&quot;: \&quot;result_data\&quot;}&quot;</span>
            <span class="token string">&quot;如果是画图意图，使用python代码生成图片数据后保存到内存中，最后返回缓冲区内容到image_result变量中&quot;</span>
            <span class="token string">&quot;如果返回的result_type是text，直接展示result_data&quot;</span>
            <span class="token string">&quot;如果是code，result_data内容使用python代码实现&quot;</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        result <span class="token operator">=</span> agent_executor<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;result below: &quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        format_result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">&quot;output&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> format_result<span class="token punctuation">[</span><span class="token string">&quot;query_sql&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format_result<span class="token punctuation">[</span><span class="token string">&quot;result_type&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format_result<span class="token punctuation">[</span><span class="token string">&quot;result_data&quot;</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">[</span><span class="token string">&quot;output&quot;</span><span class="token punctuation">]</span>
        <span class="token comment"># raise HTTPException(status_code=500, detail=str(e))</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">&quot;/image&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">image</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> QueryRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> request<span class="token punctuation">.</span>question

    <span class="token keyword">if</span> <span class="token keyword">not</span> question<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>status_code<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> detail<span class="token operator">=</span><span class="token string">&quot;No question provided&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span>

        response <span class="token operator">=</span> client<span class="token punctuation">.</span>images<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>
            model<span class="token operator">=</span><span class="token string">&quot;dall-e-3&quot;</span><span class="token punctuation">,</span>
            response_format<span class="token operator">=</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span>  <span class="token comment"># &quot;url&quot;,&quot;b64_json&quot;</span>
            prompt<span class="token operator">=</span>question<span class="token punctuation">,</span>
            size<span class="token operator">=</span><span class="token string">&quot;1024x1024&quot;</span><span class="token punctuation">,</span>
            quality<span class="token operator">=</span><span class="token string">&quot;standard&quot;</span><span class="token punctuation">,</span>
            n<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        image_data <span class="token operator">=</span> response<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;image_data&quot;</span><span class="token punctuation">:</span> image_data<span class="token punctuation">}</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;image_data&quot;</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span>


<span class="token comment"># 运行应用时，使用 `uvicorn main:app --reload` 命令启动服务器</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>Python搭建Web服务 - Gradio - 数据猎手</p></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> io
<span class="token keyword">import</span> json
<span class="token keyword">import</span> gradio <span class="token keyword">as</span> gr
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token comment"># URL of the FastAPI endpoint</span>
FASTAPI_URL <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8000&quot;</span>


<span class="token keyword">def</span> <span class="token function">query_api</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>FASTAPI_URL <span class="token operator">+</span> <span class="token string">'/query'</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;question&quot;</span><span class="token punctuation">:</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;detail&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;An error occurred&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">text_to_speech</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> yz_flag<span class="token punctuation">,</span> ys_flag<span class="token punctuation">,</span> yl_flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    audio_result <span class="token operator">=</span> generate_audio<span class="token punctuation">(</span>content<span class="token punctuation">,</span> yz_flag<span class="token punctuation">,</span> ys_flag<span class="token punctuation">,</span> yl_flag<span class="token punctuation">)</span>
    <span class="token keyword">return</span> audio_result


<span class="token keyword">def</span> <span class="token function">text_to_image</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>FASTAPI_URL <span class="token operator">+</span> <span class="token string">'/image'</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;question&quot;</span><span class="token punctuation">:</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token string">&quot;image_data&quot;</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;detail&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;An error occurred&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>


<span class="token keyword">def</span> <span class="token function">drawer</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这个函数用于执行代码</span>
    globals_<span class="token punctuation">,</span> locals_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> globals_<span class="token punctuation">,</span> locals_<span class="token punctuation">)</span>
    image_bytes <span class="token operator">=</span> locals_<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'image_result'</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>image_bytes<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> image


<span class="token keyword">def</span> <span class="token function">generate_audio</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> yz_flag<span class="token punctuation">,</span> ys_flag<span class="token punctuation">,</span> yl_flag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">&quot;http://xx.xx.xx.xx:xxxx/api/audios/generations&quot;</span>
        yz_flag_dict <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'zh-CN-XiaoxiaoNeural'</span><span class="token punctuation">:</span> <span class="token string">'中文 女性'</span><span class="token punctuation">,</span>
            <span class="token string">'zh-CN-YunjianNeural'</span><span class="token punctuation">:</span> <span class="token string">'中文 男性'</span><span class="token punctuation">,</span>
            <span class="token string">'en-GB-LibbyNeural'</span><span class="token punctuation">:</span> <span class="token string">'英语 女性'</span><span class="token punctuation">,</span>
            <span class="token string">'en-GB-RyanNeural'</span><span class="token punctuation">:</span> <span class="token string">'英语 男性'</span>
        <span class="token punctuation">}</span>
        voice <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> yz_flag_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> value <span class="token operator">==</span> yz_flag<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'中文 女性'</span><span class="token punctuation">)</span>

        payload <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;text&quot;</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
            <span class="token string">&quot;voice&quot;</span><span class="token punctuation">:</span> voice<span class="token punctuation">,</span>
            <span class="token string">&quot;rate&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;+</span><span class="token interpolation"><span class="token punctuation">{</span>ys_flag<span class="token punctuation">}</span></span><span class="token string">%&quot;</span></span><span class="token punctuation">,</span>
            <span class="token string">&quot;volume&quot;</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f&quot;+</span><span class="token interpolation"><span class="token punctuation">{</span>yl_flag<span class="token punctuation">}</span></span><span class="token string">%&quot;</span></span>
        <span class="token punctuation">}</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;TTS请求参数：&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>payload<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        headers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'*/*'</span><span class="token punctuation">,</span>
            <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'zh-CN,zh;q=0.9'</span><span class="token punctuation">,</span>
            <span class="token string">'Authorization'</span><span class="token punctuation">:</span> <span class="token string">'AIACC'</span><span class="token punctuation">,</span>
            <span class="token string">'Cache-Control'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
            <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>
            <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
            <span class="token string">'Origin'</span><span class="token punctuation">:</span> <span class="token string">'null'</span><span class="token punctuation">,</span>
            <span class="token string">'Pragma'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
            <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36'</span>
        <span class="token punctuation">}</span>

        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;TTS请求响应码：&quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 确认请求成功</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token comment"># 获取音频二进制内容</span>
            audio_content <span class="token operator">=</span> response<span class="token punctuation">.</span>content
            <span class="token comment"># 使用BytesIO包装音频内容，以便Gradio可以播放</span>
            <span class="token comment"># audio_file = io.BytesIO(audio_content)</span>
            <span class="token comment"># audio_file.seek(0)  # 确保位置指针在开始位置</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;TTS请求内容：&quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>audio_content<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> audio_content
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 处理错误情况</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Failed to get TTS: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">.</span>status_code<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Failed to get TTS: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>


<span class="token keyword">def</span> <span class="token function">clear_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这个函数返回每个组件的默认值，以清除内容</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token boolean">None</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Blocks<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> demo<span class="token punctuation">:</span>
        <span class="token comment"># 定义样例数据</span>
        examples <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;查询全部的表名&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;查询xxx表设计并给出相应的优化建议&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;查询xxx表，按月统计出前五条记录最多的月份，查询后的结果画柱状图&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;查询xxx表，按月统计出前五条记录最多的月份，查询出的结果画饼图&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;查询xxx表，按月统计出前五条记录最多的月份，查询出的结果画折线图&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;查询xxx表，按月统计出前五条记录最多的月份，查询出的结果画散点图&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;查询xxx表，按月统计出前五条记录最多的月份，查询出的结果画词云图&quot;</span>
        <span class="token punctuation">]</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token string">&quot;## 数据猎手&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            question_input <span class="token operator">=</span> gr<span class="token punctuation">.</span>TextArea<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;输入&quot;</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span><span class="token string">&quot;输入你的问题，例如：查询某表设计并给出相应的优化建议&quot;</span><span class="token punctuation">)</span>
            <span class="token comment"># 添加样例链接</span>
            gr<span class="token punctuation">.</span>Examples<span class="token punctuation">(</span>examples<span class="token punctuation">,</span> inputs<span class="token operator">=</span>question_input<span class="token punctuation">)</span>

        result_sql <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;查询语句&quot;</span><span class="token punctuation">)</span>
        result_type <span class="token operator">=</span> gr<span class="token punctuation">.</span>Radio<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">&quot;结果类型&quot;</span><span class="token punctuation">,</span> visible<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Tab<span class="token punctuation">(</span><span class="token string">&quot;输出&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                text_result <span class="token operator">=</span> gr<span class="token punctuation">.</span>TextArea<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;文本&quot;</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span><span class="token string">&quot;输出的内容&quot;</span><span class="token punctuation">)</span>
                text_image <span class="token operator">=</span> gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;图表&quot;</span><span class="token punctuation">)</span>

            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 添加查询按钮</span>
                submit_button <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">&quot;查 询&quot;</span><span class="token punctuation">,</span> variant<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span><span class="token punctuation">)</span>
                submit_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
                    fn<span class="token operator">=</span>query_api<span class="token punctuation">,</span>
                    inputs<span class="token operator">=</span><span class="token punctuation">[</span>question_input<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    outputs<span class="token operator">=</span><span class="token punctuation">[</span>result_sql<span class="token punctuation">,</span> result_type<span class="token punctuation">,</span> text_result<span class="token punctuation">]</span>
                <span class="token punctuation">)</span>
                <span class="token comment"># 添加生成图像按钮</span>
                execute_button <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">&quot;代码转图片&quot;</span><span class="token punctuation">,</span> variant<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span><span class="token punctuation">)</span>
                execute_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
                    fn<span class="token operator">=</span>drawer<span class="token punctuation">,</span>
                    inputs<span class="token operator">=</span><span class="token punctuation">[</span>text_result<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    outputs<span class="token operator">=</span>text_image
                <span class="token punctuation">)</span>

        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Tab<span class="token punctuation">(</span><span class="token string">&quot;音频&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                audio_text <span class="token operator">=</span> gr<span class="token punctuation">.</span>TextArea<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;文本&quot;</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span><span class="token string">&quot;输入文字内容&quot;</span><span class="token punctuation">)</span>
                audio_result <span class="token operator">=</span> gr<span class="token punctuation">.</span>Audio<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;音频&quot;</span><span class="token punctuation">)</span>

            <span class="token comment"># 创建一个Accordion组件，其中包含additional_inputs</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Accordion<span class="token punctuation">(</span><span class="token string">&quot;其他设置&quot;</span><span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    yz_flag <span class="token operator">=</span> gr<span class="token punctuation">.</span>Dropdown<span class="token punctuation">(</span>
                        <span class="token punctuation">[</span><span class="token string">&quot;中文 女性&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;中文 男性&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;英文 女性&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;英文 男性&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        label<span class="token operator">=</span><span class="token string">&quot;语种&quot;</span><span class="token punctuation">,</span>
                        value<span class="token operator">=</span><span class="token string">&quot;中文 女性&quot;</span>
                    <span class="token punctuation">)</span>
                    ys_flag <span class="token operator">=</span> gr<span class="token punctuation">.</span>Slider<span class="token punctuation">(</span>minimum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> maximum<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">&quot;语速&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
                    yl_flag <span class="token operator">=</span> gr<span class="token punctuation">.</span>Slider<span class="token punctuation">(</span>minimum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> maximum<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">&quot;音量&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>

            <span class="token comment"># 添加生成音频按钮</span>
            audio_button <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">&quot;文字转语音&quot;</span><span class="token punctuation">,</span> variant<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span><span class="token punctuation">)</span>
            audio_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
                fn<span class="token operator">=</span>text_to_speech<span class="token punctuation">,</span>
                inputs<span class="token operator">=</span><span class="token punctuation">[</span>audio_text<span class="token punctuation">,</span> yz_flag<span class="token punctuation">,</span> ys_flag<span class="token punctuation">,</span> yl_flag<span class="token punctuation">]</span><span class="token punctuation">,</span>
                outputs<span class="token operator">=</span>audio_result
            <span class="token punctuation">)</span>

        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Tab<span class="token punctuation">(</span><span class="token string">&quot;图片&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                image_text <span class="token operator">=</span> gr<span class="token punctuation">.</span>TextArea<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;文本&quot;</span><span class="token punctuation">,</span> placeholder<span class="token operator">=</span><span class="token string">&quot;输入文字内容&quot;</span><span class="token punctuation">)</span>
                image_result <span class="token operator">=</span> gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&quot;图片&quot;</span><span class="token punctuation">)</span>

            <span class="token comment"># 添加生成图片按钮</span>
            audio_button <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">&quot;文字转图片&quot;</span><span class="token punctuation">,</span> variant<span class="token operator">=</span><span class="token string">&quot;primary&quot;</span><span class="token punctuation">)</span>
            audio_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
                fn<span class="token operator">=</span>text_to_image<span class="token punctuation">,</span>
                inputs<span class="token operator">=</span><span class="token punctuation">[</span>image_text<span class="token punctuation">]</span><span class="token punctuation">,</span>
                outputs<span class="token operator">=</span>image_result
            <span class="token punctuation">)</span>

        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 添加清除所有内容按钮</span>
            clear_button <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">&quot;重 置&quot;</span><span class="token punctuation">)</span>
            clear_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
                fn<span class="token operator">=</span>clear_contents<span class="token punctuation">,</span>
                inputs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                outputs<span class="token operator">=</span><span class="token punctuation">[</span>
                    question_input<span class="token punctuation">,</span>
                    result_sql<span class="token punctuation">,</span>
                    result_type<span class="token punctuation">,</span>
                    text_result<span class="token punctuation">,</span>
                    text_image<span class="token punctuation">,</span>
                    image_text<span class="token punctuation">,</span>
                    image_result<span class="token punctuation">,</span>
                    audio_text<span class="token punctuation">,</span>
                    audio_result
                <span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

    <span class="token comment"># demo.launch(server_name='0.0.0.0', server_port=7860, show_error=True, auth=(&quot;admin&quot;, &quot;admin1234&quot;))</span>
    <span class="token comment"># demo.launch(share=True)</span>
    demo<span class="token punctuation">.</span>launch<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br></div></div><div class="custom-block tip"><p class="title"></p><p>windows 端口映射规则管理器</p></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> tkinter <span class="token keyword">import</span> ttk
<span class="token keyword">from</span> tkinter <span class="token keyword">import</span> messagebox
<span class="token keyword">import</span> tkinter <span class="token keyword">as</span> tk
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> socket


<span class="token keyword">def</span> <span class="token function">check_fields</span><span class="token punctuation">(</span>listen_port<span class="token punctuation">,</span> rule_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 检查listen_port和rule_name是否为空</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> listen_port <span class="token keyword">or</span> <span class="token keyword">not</span> rule_name<span class="token punctuation">:</span>
        messagebox<span class="token punctuation">.</span>showwarning<span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Please ensure Listen Port and Rule Name are not empty.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token keyword">def</span> <span class="token function">add_rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    listen_address <span class="token operator">=</span> address_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    listen_port <span class="token operator">=</span> port_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    protocol <span class="token operator">=</span> protocol_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rule_name <span class="token operator">=</span> rule_name_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> check_fields<span class="token punctuation">(</span>listen_port<span class="token punctuation">,</span> rule_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    commands <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string-interpolation"><span class="token string">f&quot;netsh interface portproxy add v4tov4 listenaddress=</span><span class="token interpolation"><span class="token punctuation">{</span>listen_address<span class="token punctuation">}</span></span><span class="token string"> listenport=</span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string"> protocol=</span><span class="token interpolation"><span class="token punctuation">{</span>protocol<span class="token punctuation">}</span></span><span class="token string"> connectaddress=127.0.0.1 connectport=</span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f&quot;netsh advfirewall firewall add rule name=</span><span class="token interpolation"><span class="token punctuation">{</span>rule_name<span class="token punctuation">}</span></span><span class="token string"> dir=in action=allow protocol=TCP localport=</span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">]</span>
    <span class="token keyword">for</span> cmd <span class="token keyword">in</span> commands<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Adding rule: </span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">&quot;Success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Portproxy and firewall rule added.&quot;</span><span class="token punctuation">)</span>

    <span class="token comment"># 更新端口号列表</span>
    port_entry<span class="token punctuation">[</span><span class="token string">'values'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_port_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    port_entry<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    rule_name_entry<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">delete_rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    listen_address <span class="token operator">=</span> address_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    listen_port <span class="token operator">=</span> port_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    protocol <span class="token operator">=</span> protocol_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rule_name <span class="token operator">=</span> rule_name_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> check_fields<span class="token punctuation">(</span>listen_port<span class="token punctuation">,</span> rule_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    commands <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string-interpolation"><span class="token string">f&quot;netsh interface portproxy delete v4tov4 listenaddress=</span><span class="token interpolation"><span class="token punctuation">{</span>listen_address<span class="token punctuation">}</span></span><span class="token string"> listenport=</span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string"> protocol=</span><span class="token interpolation"><span class="token punctuation">{</span>protocol<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f&quot;netsh advfirewall firewall delete rule name=</span><span class="token interpolation"><span class="token punctuation">{</span>rule_name<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
    <span class="token punctuation">]</span>
    <span class="token keyword">for</span> cmd <span class="token keyword">in</span> commands<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Deleting rule: </span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">&quot;Success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Portproxy and firewall rule deleted.&quot;</span><span class="token punctuation">)</span>

    <span class="token comment"># 更新端口号列表</span>
    port_entry<span class="token punctuation">[</span><span class="token string">'values'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_port_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    port_entry<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    rule_name_entry<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">query_proxy_rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    listen_port <span class="token operator">=</span> port_entry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 检查listen_port和rule_name是否为空</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> listen_port<span class="token punctuation">:</span>
        messagebox<span class="token punctuation">.</span>showwarning<span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Please ensure Listen Port are not empty.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    cmd <span class="token operator">=</span> <span class="token string">&quot;netsh interface portproxy show all&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Querying: </span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>  <span class="token comment"># 尝试解码为UTF-8</span>
    <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>  <span class="token comment"># 如果UTF-8失败，尝试GBK</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string-interpolation"><span class="token string">f&quot;</span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span> <span class="token keyword">not</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>
        messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">&quot;Result&quot;</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&quot;No portproxy rule found for the given port </span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string">.&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        messagebox<span class="token punctuation">.</span>showinfo<span class="token punctuation">(</span><span class="token string">&quot;Result&quot;</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&quot;Portproxy rule found for </span><span class="token interpolation"><span class="token punctuation">{</span>listen_port<span class="token punctuation">}</span></span><span class="token string">.&quot;</span></span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_port_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    cmd <span class="token operator">=</span> <span class="token string">&quot;netsh interface portproxy show all&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Querying: </span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>  <span class="token comment"># 尝试解码为UTF-8</span>
    <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>  <span class="token comment"># 如果UTF-8失败，尝试GBK</span>
    port_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">&quot;127.0.0.1&quot;</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            port <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            port_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token keyword">return</span> port_list


<span class="token keyword">def</span> <span class="token function">get_file_wall_list</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> event<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cmd <span class="token operator">=</span> <span class="token string">&quot;netsh advfirewall firewall show rule name=all&quot;</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Querying: </span><span class="token interpolation"><span class="token punctuation">{</span>cmd<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>  <span class="token comment"># 尝试解码为UTF-8</span>
    <span class="token keyword">except</span> UnicodeDecodeError<span class="token punctuation">:</span>
        result <span class="token operator">=</span> result<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>  <span class="token comment"># 如果UTF-8失败，尝试GBK</span>
    rules <span class="token operator">=</span> parse_firewall_rules<span class="token punctuation">(</span>result<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

    <span class="token comment"># 返回规则名称列表</span>
    rule_name_list <span class="token operator">=</span> <span class="token punctuation">[</span>rule<span class="token punctuation">[</span><span class="token string">'规则名称'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> rule <span class="token keyword">in</span> rules<span class="token punctuation">]</span>
    rule_name_entry<span class="token punctuation">[</span><span class="token string">'values'</span><span class="token punctuation">]</span> <span class="token operator">=</span> rule_name_list
    rule_name_entry<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>rule_name_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rule_name_list<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">parse_firewall_rules</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    rules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    rule <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    lines <span class="token operator">=</span> output<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    name_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'HTTP-In'</span><span class="token punctuation">,</span> <span class="token string">'HTTP-Out'</span><span class="token punctuation">,</span> <span class="token string">'HTTP-Streaming-In'</span><span class="token punctuation">,</span> <span class="token string">'NB-Session-In'</span><span class="token punctuation">,</span> <span class="token string">'NP-In'</span><span class="token punctuation">,</span> <span class="token string">'PPTP-In'</span><span class="token punctuation">,</span> <span class="token string">'RTSP-Streaming-In'</span><span class="token punctuation">,</span>
                 <span class="token string">'SMB-In'</span><span class="token punctuation">,</span> <span class="token string">'SSDP TCP-In'</span><span class="token punctuation">,</span> <span class="token string">'SSTP-In'</span><span class="token punctuation">,</span> <span class="token string">'TCP'</span><span class="token punctuation">,</span> <span class="token string">'TCP-In'</span><span class="token punctuation">,</span> <span class="token string">'TCP-WS-In'</span><span class="token punctuation">,</span> <span class="token string">'TCP-WSS-In'</span><span class="token punctuation">,</span> <span class="token string">'UPnP-In'</span><span class="token punctuation">,</span>
                 <span class="token string">'WSD Events-In'</span><span class="token punctuation">,</span> <span class="token string">'WSD EventsSecure-In'</span><span class="token punctuation">,</span> <span class="token string">'iWARP-In'</span><span class="token punctuation">,</span> <span class="token string">'qWave-TCP-In'</span><span class="token punctuation">,</span> <span class="token string">'DCOM-In'</span><span class="token punctuation">,</span> <span class="token string">'@FirewallAPI'</span><span class="token punctuation">,</span>
                 <span class="token string">'家庭组输入'</span><span class="token punctuation">]</span>  <span class="token comment"># 过滤规则名称</span>
    rule_name_index <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'------'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            rule_name_index <span class="token operator">=</span> index
            <span class="token keyword">if</span> rule<span class="token punctuation">:</span>
                rules<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rule<span class="token punctuation">)</span>
                rule <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                key<span class="token punctuation">,</span> value <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token comment"># 检查value是否为空，如果为空则直接跳过</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> value<span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                rule<span class="token punctuation">[</span>key<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
                <span class="token comment"># 这里可以记录日志或者处理这种特殊情况下数据的其他方式</span>
                <span class="token keyword">pass</span>
            <span class="token keyword">if</span> <span class="token string">&quot;规则名称&quot;</span> <span class="token keyword">in</span> rule <span class="token keyword">and</span> <span class="token string">&quot;本地端口&quot;</span> <span class="token keyword">in</span> rule<span class="token punctuation">:</span>
                <span class="token keyword">if</span> rule<span class="token punctuation">[</span><span class="token string">&quot;本地端口&quot;</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'任何'</span><span class="token punctuation">,</span> <span class="token string">'RPC'</span><span class="token punctuation">,</span> <span class="token string">'RPC-EPMap'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> rule<span class="token punctuation">[</span><span class="token string">&quot;协议&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'TCP'</span><span class="token punctuation">:</span>
                        rule<span class="token punctuation">[</span><span class="token string">&quot;规则名称&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> lines<span class="token punctuation">[</span>rule_name_index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token builtin">all</span><span class="token punctuation">(</span>name <span class="token keyword">not</span> <span class="token keyword">in</span> rule<span class="token punctuation">[</span><span class="token string">&quot;规则名称&quot;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> name_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span>rule<span class="token punctuation">[</span><span class="token string">&quot;规则名称&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rule<span class="token punctuation">[</span><span class="token string">&quot;本地端口&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rule<span class="token punctuation">[</span><span class="token string">&quot;协议&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 处理最后一个规则</span>
    <span class="token keyword">if</span> rule<span class="token punctuation">:</span>
        rules<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rule<span class="token punctuation">)</span>
    <span class="token comment"># 过滤掉没有端口的规则</span>
    <span class="token comment"># 过滤掉没有端口的规则，并且本地端口不在['任何','RPC','RPC-EPMap']中，协议为'TCP'</span>
    filter_rules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> rule <span class="token keyword">in</span> rules<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">'本地端口'</span> <span class="token keyword">in</span> rule <span class="token keyword">and</span> rule<span class="token punctuation">[</span><span class="token string">'本地端口'</span><span class="token punctuation">]</span> <span class="token operator">==</span> port<span class="token punctuation">:</span>
            <span class="token keyword">if</span> rule<span class="token punctuation">[</span><span class="token string">&quot;本地端口&quot;</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'任何'</span><span class="token punctuation">,</span> <span class="token string">'RPC'</span><span class="token punctuation">,</span> <span class="token string">'RPC-EPMap'</span><span class="token punctuation">]</span> <span class="token keyword">and</span> rule<span class="token punctuation">[</span><span class="token string">&quot;协议&quot;</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'TCP'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> rule<span class="token punctuation">[</span><span class="token string">&quot;规则名称&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> name_list<span class="token punctuation">:</span>
                    filter_rules<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rule<span class="token punctuation">)</span>
    <span class="token keyword">return</span> filter_rules


<span class="token keyword">def</span> <span class="token function">on_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    root<span class="token punctuation">.</span>destroy<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_local_ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    查询本机ip地址
    :return: ip
    &quot;&quot;&quot;</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'8.8.8.8'</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ip <span class="token operator">=</span> s<span class="token punctuation">.</span>getsockname<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> ip


root <span class="token operator">=</span> tk<span class="token punctuation">.</span>Tk<span class="token punctuation">(</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">&quot;Portproxy and Firewall Rule Manager&quot;</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span><span class="token string">&quot;500x300&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 获取屏幕分辨率</span>
screen_width <span class="token operator">=</span> root<span class="token punctuation">.</span>winfo_screenwidth<span class="token punctuation">(</span><span class="token punctuation">)</span>
screen_height <span class="token operator">=</span> root<span class="token punctuation">.</span>winfo_screenheight<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 计算窗口在屏幕中央的位置</span>
x <span class="token operator">=</span> <span class="token punctuation">(</span>screen_width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">500</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 500是窗口的宽度</span>
y <span class="token operator">=</span> <span class="token punctuation">(</span>screen_height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">300</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 400是窗口的高度</span>

<span class="token comment"># 设置窗口位置</span>
root<span class="token punctuation">.</span>geometry<span class="token punctuation">(</span><span class="token string">&quot;+{}+{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 设置全局字体和颜色</span>
font <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;Helvetica&quot;</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
bg_color <span class="token operator">=</span> <span class="token string">&quot;#f0f0f0&quot;</span>
fg_color <span class="token operator">=</span> <span class="token string">&quot;#000000&quot;</span>

<span class="token comment"># 默认值</span>
address_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Listen Address:&quot;</span><span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
address_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
address_entry <span class="token operator">=</span> tk<span class="token punctuation">.</span>Entry<span class="token punctuation">(</span>root<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
address_entry<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
address_entry<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> get_local_ip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
address_entry<span class="token punctuation">.</span>config<span class="token punctuation">(</span>state<span class="token operator">=</span><span class="token string">'disabled'</span><span class="token punctuation">)</span>  <span class="token comment"># 禁用Entry</span>

port_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Listen Port:&quot;</span><span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
port_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
port_entry <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Combobox<span class="token punctuation">(</span>root<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span>
port_entry<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
port_entry<span class="token punctuation">[</span><span class="token string">'values'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_port_list<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 你可以在这个列表中添加你想要的端口号</span>
port_entry<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
port_entry<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token string">'&lt;&lt;ComboboxSelected&gt;&gt;'</span><span class="token punctuation">,</span> get_file_wall_list<span class="token punctuation">)</span>

protocol_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Protocol:&quot;</span><span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
protocol_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
protocol_entry <span class="token operator">=</span> tk<span class="token punctuation">.</span>Entry<span class="token punctuation">(</span>root<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
protocol_entry<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
protocol_entry<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">)</span>

rule_name_label <span class="token operator">=</span> tk<span class="token punctuation">.</span>Label<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Rule Name:&quot;</span><span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
rule_name_label<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
rule_name_entry <span class="token operator">=</span> ttk<span class="token punctuation">.</span>Combobox<span class="token punctuation">(</span>root<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span>
rule_name_entry<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment"># 添加规则按钮</span>
add_rule_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Add Rule&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>add_rule<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
add_rule_button<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment"># 删除规则按钮</span>
delete_rule_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Delete Rule&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>delete_rule<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
delete_rule_button<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment"># 查询规则按钮</span>
query_rule_button <span class="token operator">=</span> tk<span class="token punctuation">.</span>Button<span class="token punctuation">(</span>root<span class="token punctuation">,</span> text<span class="token operator">=</span><span class="token string">&quot;Query Rule&quot;</span><span class="token punctuation">,</span> command<span class="token operator">=</span>query_proxy_rule<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> bg<span class="token operator">=</span>bg_color<span class="token punctuation">,</span> fg<span class="token operator">=</span>fg_color<span class="token punctuation">)</span>
query_rule_button<span class="token punctuation">.</span>grid<span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> column<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padx<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> pady<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

root<span class="token punctuation">.</span>mainloop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 打包</span>
<span class="token comment"># pyinstaller --onefile --windowed window_port.py</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br></div></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="https://res.wx.qq.com/voice/getvoice?mediaid=MzIxMzExNDQwMl8xMDAwMTAxMjQ=" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:20px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="https://zhengxiaojun.github.io/blogs/avatar.png" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(https://zhengxiaojun.github.io/blogs/avatar.png);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>等一分钟 Wait One Minute</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>徐誉滕</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/blogs/assets/js/app.f400a914.js" defer></script><script src="/blogs/assets/js/7.ebdb849f.js" defer></script><script src="/blogs/assets/js/2.cd33bdb9.js" defer></script><script src="/blogs/assets/js/1.5c5de54b.js" defer></script><script src="/blogs/assets/js/47.dc54d0bf.js" defer></script>
  </body>
</html>
